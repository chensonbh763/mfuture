<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Abastecimento</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    nav {
      background: #161b22;
      display: flex;
      justify-content: space-around;
      padding: 0.6rem 0;
      border-top: 1px solid #30363d;
      position: sticky;
      bottom: 0;
    }
    nav a {
      color: #8b949e;
      text-decoration: none;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    nav a.active {
      color: #58a6ff;
    }
    nav i {
      font-size: 1.3rem;
      margin-bottom: 0.2rem;
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
  <header class="bg-gray-800 p-4 text-center text-xl font-bold">Abastecimento</header>

  <main class="flex-1 p-4 space-y-6">
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4">Registrar Abastecimento</h2>
      <form id="formAbastecimento" class="space-y-3">
        <div>
          <label class="block mb-1">Data:</label>
          <input type="date" id="data" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        </div>
        <div>
          <label class="block mb-1">Valor Total (R$):</label>
          <input type="number" step="0.01" id="valor" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        </div>
        <div>
          <label class="block mb-1">Litros:</label>
          <input type="number" step="0.01" id="litros" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        </div>
        <div>
          <label class="block mb-1">Quilometragem Atual (km):</label>
          <input type="number" id="km" class="w-full p-2 rounded bg-gray-700 border border-gray-600">
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">Registrar</button>
      </form>
    </div>

    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4">Resumo</h2>
      <p id="resumo"></p>
    </div>

    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4">Hist√≥rico</h2>
      <table class="w-full text-left text-sm">
        <thead>
          <tr class="border-b border-gray-700">
            <th>Data</th>
            <th>Valor (R$)</th>
            <th>Litros</th>
            <th>Km/L</th>
          </tr>
        </thead>
        <tbody id="tabelaAbastecimento"></tbody>
      </table>
    </div>
  </main>

  <nav>
    <a href="index.html"><i>üè†</i>In√≠cio</a>
    <a href="ganhos.html"><i>üí∞</i>Ganhos</a>
    <a href="abastecimento.html" class="active"><i>‚õΩ</i>Abastecimento</a>
    <a href="gastos.html"><i>üí≥</i>Gastos</a>
    <a href="relatorios.html"><i>üìä</i>Relat√≥rios</a>
  </nav>

<script src="config.js"></script>
<script>
const SHEET_NAME = "Abastecimentos";

// Fun√ß√£o principal de envio do formul√°rio
document.getElementById("formAbastecimento").addEventListener("submit", async function (e) {
  e.preventDefault();

  const data = document.getElementById("data").value;
  const valor = parseFloat(document.getElementById("valor").value) || 0;
  const litros = parseFloat(document.getElementById("litros").value) || 0;
  const kmAtual = parseFloat(document.getElementById("km").value) || 0;

  if (!data || !valor || !litros || !kmAtual) {
    alert("Preencha todos os campos antes de registrar!");
    return;
  }

  // üîπ Obter o √∫ltimo registro do Google Sheets (para calcular km anterior)
  let kmAnterior = 0;
  try {
    const res = await fetch(`${scriptURL}?sheet=${SHEET_NAME}`);
    const registros = await res.json();
    if (registros.length > 1) {
      for (let i = registros.length - 1; i >= 1; i--) {
        const km = parseFloat(registros[i][3]);
        if (!isNaN(km)) {
          kmAnterior = km;
          break;
        }
      }
    }
  } catch (error) {
    console.warn("N√£o foi poss√≠vel obter o √∫ltimo registro:", error);
  }

  const kmRodado = kmAtual - kmAnterior;
  const kmPorLitro = litros > 0 ? (kmRodado / litros).toFixed(2) : "0";

  const payload = {
    sheet: SHEET_NAME,
    values: [data, valor, litros, kmAtual, kmPorLitro]
  };

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    if (result.success) {
      alert("‚úÖ Abastecimento registrado com sucesso!");
      formAbastecimento.reset();
      carregarResumo();
      carregarTabela();
    } else {
      alert("‚ö†Ô∏è Erro ao registrar: " + (result.error || "Erro desconhecido"));
    }
  } catch (error) {
    console.error("Erro ao enviar dados:", error);
    alert("‚ùå Falha ao conectar com o servidor.");
  }
});

// üîπ Carregar resumo
async function carregarResumo() {
  const resumo = document.getElementById("resumo");
  resumo.textContent = "Carregando...";

  try {
    const res = await fetch(`${scriptURL}?sheet=${SHEET_NAME}`);
    const data = await res.json();

    if (data.length <= 1) {
      resumo.textContent = "Nenhum registro encontrado.";
      return;
    }

    let totalLitros = 0, totalValor = 0;
    for (let i = 1; i < data.length; i++) {
      totalLitros += parseFloat(data[i][2]) || 0;
      totalValor += parseFloat(data[i][1]) || 0;
    }

    const media = totalValor > 0 && totalLitros > 0 ? (totalValor / totalLitros).toFixed(2) : "0.00";
    resumo.innerHTML = `
      <p><strong>Total abastecido:</strong> ${totalLitros.toFixed(2)} L</p>
      <p><strong>Total gasto:</strong> R$ ${totalValor.toFixed(2)}</p>
      <p><strong>M√©dia de pre√ßo por litro:</strong> R$ ${media}</p>
    `;
  } catch (error) {
    resumo.textContent = "Erro ao carregar resumo.";
  }
}

// üîπ Carregar tabela
async function carregarTabela() {
  const tabela = document.getElementById("tabelaAbastecimento");
  tabela.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";

  try {
    const res = await fetch(`${scriptURL}?sheet=${SHEET_NAME}`);
    const data = await res.json();

    tabela.innerHTML = "";
    for (let i = 1; i < data.length; i++) {
      const [dataAb, valor, litros, km, kmL] = data[i];
      tabela.insertAdjacentHTML("beforeend", `
        <tr class="border-b border-gray-700">
          <td>${dataAb}</td>
          <td>R$ ${(parseFloat(valor) || 0).toFixed(2)}</td>
          <td>${(parseFloat(litros) || 0).toFixed(2)} L</td>
          <td>${kmL || "-"}</td>
        </tr>
      `);
    }
  } catch (error) {
    tabela.innerHTML = "<tr><td colspan='4'>Erro ao carregar dados.</td></tr>";
  }
}

carregarResumo();
carregarTabela();
</script>

</body>
</html>
